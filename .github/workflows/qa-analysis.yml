name: QA Analysis Report

on:
  workflow_dispatch:  # Permite execu√ß√£o manual
  pull_request:
    types: [opened, synchronize]

jobs:
  qa-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
          
      - name: Restore dependencies
        run: dotnet restore
        
      - name: Build
        run: dotnet build --no-restore
        
      - name: Run tests with coverage
        run: |
          dotnet test --no-build --verbosity normal \
            /p:CollectCoverage=true \
            /p:CoverletOutputFormat=cobertura \
            /p:CoverletOutput=./coverage/
            
      - name: Install security scanner
        run: |
          dotnet tool install --global security-scan
          dotnet tool install --global dotnet-sonarscanner
          
      - name: Run security analysis
        continue-on-error: true
        run: |
          security-scan **/*.csproj --export=security-report.json || true
          
      - name: Generate QA Analysis Report
        run: |
          cat > qa-analysis-report.md << 'EOF'
          # üß™ Relat√≥rio de An√°lise QA Autom√°tica
          
          **Reposit√≥rio:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Data:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ---
          
          ## üìä M√©tricas de Qualidade
          
          ### Cobertura de Testes
          $(if [ -f coverage/coverage.cobertura.xml ]; then echo "‚úÖ Relat√≥rio gerado"; else echo "‚ùå N√£o dispon√≠vel"; fi)
          
          ### Build Status
          ‚úÖ Build executado com sucesso
          
          ### Testes
          $(dotnet test --list-tests 2>/dev/null | wc -l) testes identificados
          
          ---
          
          ## ‚ö†Ô∏è Checklist de An√°lise Manual Necess√°ria
          
          Use o prompt em: \`.github/prompts/QA_TEST_ASSIST_FULL.md\`
          
          - [ ] Analisar vulnerabilidades de seguran√ßa
          - [ ] Verificar ader√™ncia ao Swagger/OpenAPI
          - [ ] Avaliar pir√¢mide de testes
          - [ ] Revisar API First
          - [ ] Identificar pontos cr√≠ticos
          
          ---
          
          ## üîó Pr√≥ximos Passos
          
          1. Execute o super prompt localmente com GitHub Copilot
          2. Revise os arquivos VULNERABILITIES.md e TEST-COVERAGE.md
          3. Priorize as corre√ß√µes por impacto
          
          EOF
          
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          
      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('qa-analysis-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
